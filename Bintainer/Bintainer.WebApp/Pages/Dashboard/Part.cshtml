@page "/dashboard/part"
@using Bintainer.Model.Entity
@using Bintainer.Model.View
@using System.Text.Json
@model PartModel
@{
}

@Html.AntiForgeryToken()
@* <link rel="stylesheet" href="~/css/hierarchy-select.min.css"> *@
<link rel="stylesheet" href="~/css/autocomplete.css">
<link rel="stylesheet" href="~/css/part-page-customization.css">
<link rel="stylesheet" href="~/css/treeeditor.css" />

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js" type="module"></script> 
<style>
    ::placeholder {
        font-size: 12px;        
        font-style: italic;
    }

    .input-sharp {
        height: 30px; /* Reduced height */
        border-radius: 0; /* Sharp corners */
        border: 1px solid #ced4da; /* Custom border color */
        background-color: #ffffff; /* Background color */
        color: #002060; /* Text color */
    }

    .load-button-sharp {
        height: 30px; /* Reduced height */
        border-radius: 0; /* Sharp corners */        
    }

    .input-sharp:focus {
        border-color: #0062cc; /* Focus border color */
        box-shadow: 0 0 0 0.2rem rgba(0, 98, 204, 0.25); /* Focus glow effect */
    }


    .button-row {
        display: flex;
        align-items: center; /* Vertically center content */
        height: 30px; /* Set height to 30px */
    }    
    /* Style for the button inside .button-row */
    .button-row .btn {
            border-radius: 0; /* Sharp corners for button */
            margin-right: 10px; /* Add margin between button and select */
            font-size: 14px; /* Reduce font size */
    }
    /* Style for the select inside .button-row */
    .button-row select {
            height: 100%; /* Fill the height of the .button-row */
            border-radius: 0; /* Sharp corners for select */
            border: none; /* Remove default border */
            padding: 5px; /* Adjust padding */
            font-size: 14px; /* Reduce font size */
            width: max-content; /* Fit width to content */
    }

    .collapse {
        transition: height 0.3s ease, opacity 0.3s ease;
    }

     form .error {
        color: #ff0000;
    }
</style>

<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link active" aria-current="page" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-part" href="#">Create</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="update-tab" data-bs-toggle="tab" data-bs-target="#update-part" href="#">Update</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="arrange-tab" data-bs-toggle="tab" data-bs-target="#arrange-part" href="#">Arrange</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" id="usage-tab" data-bs-toggle="tab" data-bs-target="#usage-part" href="#">Usage</a>
    </li>
</ul>

<div class="tab-content">
    <div id="create-part" class="tab-pane fade show active" role="tabpanel" aria-labelledby="create-tab">
        <div class="container">
            <div class="row">
                <div class="col-md-8" style="margin-left: 10px;">
                    <form id="createPartForm" class="well form-horizontal" method="post">
                        <fieldset>
                            <legend><h2>Part</h2></legend>
                            <hr />
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Part number</label>
                                        <input id="partNumber" name="partNumber" placeholder="e.g., 2N2222A" class="form-control  input-sharp" required="required" type="text">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label">Description</label>
                                        <input id="description" name="description" placeholder="e.g., TRANSISTOR DIS.800mA 50V NPN TO-18" class="form-control  input-sharp" required="required" type="text">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label">Supplier</label>
                                        <input id="supplier" name="supplier" placeholder="e.g., Digikey" class="form-control  input-sharp" type="text">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="control-label">Package/Footprint</label>
                                        <input type="text" class="form-control  input-sharp autocomplete" id="packageInput" placeholder="e.g., SOIC" />
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="control-label">Group</label>
                                        <input type="text" class="form-control  input-sharp autocomplete" id="groupInput" placeholder="e.g., Usb" />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="mb-4"></div>
                        <fieldset>
                            <legend><h2>Category</h2></legend>
                            <hr />
                            <div class="row">
                                <div class="form-group">
                                    <label class="control-label">Category</label>
                                    <div class="create-part-category-treeview"></div>
                                    @*                                         <select id="categorySelect" class="form-select form-select-sm"
                                    required="required"
                                    asp-items="@(new SelectList(Model.Category,nameof(CategoryViewModel.Id),nameof(CategoryViewModel.Title)))">
                                    <option value="">Select Category</option>
                                    </select> *@
                                </div>
                            </div>                            
                        </fieldset>
                        <fieldset>
                            <legend><h2>Attributes</h2></legend>
                            <hr />
                            <div class="button-row align-items-start">
                                <div class="col-4">
                                    <select id="templateList" class="form-select form-select-lg mb-3 w-100"
                                            aria-label=".form-select-lg example"
                                            asp-items="@(new SelectList(Model.AttributeTemplatesList,"GuidId","TemplateName"))"
                                            target-table="attributeTable">
                                        <option selected value="">Templates</option>
                                    </select>
                                </div>
                            </div>
                            <div style="margin-bottom: 20px;"></div>
                            <table class="table" id="attributeTable">
                                <thead>
                                    <tr>
                                        <th>Product Attribute</th>
                                        <th>Attribute Value</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="productSpecTable"></tbody>
                            </table>
                        </fieldset>
                        <div class="mb-4"></div>
                        <fieldset>
                            <legend><h2>Suppliers</h2></legend>
                            <hr />
                            <table class="table" id="supplierTable">
                                <thead>
                                    <tr>
                                        <th>Supplier</th>
                                        <th>Part Number</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="supplierPartNumberTable">
                                    <tr>
                                        <td class="dtable-col1">
                                            <span>
                                                Digikey
                                            </span>
                                        </td>
                                        <td class="dtable-col2">
                                            <input type="text" class="form-control input-sharp" id="digikeyPartNumber" placeholder="Digikey part number">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-success button-row" id="fetchDigikey" target-table="attributeTable">Fetch </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="dtable-col1">
                                            <span>
                                                Mouser
                                            </span>
                                        </td>
                                        <td class="dtable-col2">
                                            <input type="text" class="form-control input-sharp" placeholder="Mouser part number">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-success button-row">Fetch </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </fieldset>
                        <div class="button-row align-items-end justify-content-end mt-5">
                            @* <button type="button" class="btn btn-danger">Cancel</button> *@
                            <button type="submit" class="btn btn-success" id="createPartBtn">Create</button>
                        </div>
                    </form>
                </div>
                <div class="col-md-2">
                    <div class="card card-custom">
                        <button type="button" class="btn btn-secondary load-button-sharp">Part</button>
                        <img src="~/image/microchip.png" id="partImage" class="img-fluid" alt="part image" />
                    </div>
                    <div class="card card-custom">
                        <button type="button" class="btn btn-secondary load-button-sharp">Footprint</button>
                        <img src="~/image/pinout.png" class="img-fluid" alt="footpring" />
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="update-part" class="tab-pane fade" role="tabpanel" aria-labelledby="update-tab"> 
        <div class="container">
            <div class="row">
                <div class="col-md-9" style="margin-left: 10px;">
                    <form id="searchPartForUpdateForm" class="well form-horizontal" method="post">
                        <fieldset>
                            <legend><h2>Search part</h2></legend>
                            <hr />
                            <div class="col-md-9">
                                <div class="row align-items-center">
                                    <div class="col-md-2">
                                        <div class="row">
                                            <label for="partNumber" class="form-label">Part number</label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="autocomplete">
                                            <input type="text" class="form-control input-sharp" id="searchPartNumberForUpdate" placeholder="Part number" data-autocomplete-options="updatePartNumberListData" required="required">
                                            <div id="updatePartNumberListData" style="display:none;">
                                                @Html.Raw(Json.Serialize(Model.PartNumbers.Select(p => p.Trim())))
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <button type="button" class="button-row btn btn-primary" id="searchPartBtn">Search</button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <div class="mb-4"></div>
                    </form>
                    <div id="part-details-section" class="collapse">
                        <form id="updatePartForm" class="well form-horizontal" method="post">
                            <fieldset>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label">Part number</label>
                                            <input id="updatePartNumber" name="updatePartNumber" class="form-control  input-sharp" type="text" required="required">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">Description</label>
                                            <input id="updatePartDescription" name="updatePartDescription" class="form-control  input-sharp" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">Supplier</label>
                                            <input id="updatePartSupplier" name="updatePartSupplier" class="form-control  input-sharp" type="text">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label">Package/Footprint</label>
                                            <input type="text" class="form-control  input-sharp autocomplete" id="updatePartPackageInput" required="required" />
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">Group</label>
                                            <input type="text" class="form-control  input-sharp autocomplete" id="updatePartGroupInput" />
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                            <div class="mb-4"></div>
                            <fieldset>
                                <legend><h2>Category</h2></legend>
                                <hr />
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="updatePartCurrentCategory" class="form-label"><i>Current category</i></label>
                                        <span id="updatePartCurrentCategory" class="form-control input-sharp"></span>
                                    </div>
                                </div>
                                <div class="mb-4"></div>
                                <div class="row">
                                    <div class="form-group">
                                        <label class="control-label"><i>Update category to</i></label>
                                        <div class="mb-4"></div>
                                        <div id="update-part-category-treeview" class="category-treeview"></div>
                                    </div>
                                </div>
                            </fieldset>
                            <div class="mb-4"></div>
                            <fieldset>
                                <legend><h2>Attributes</h2></legend>
                                <hr />
                                <div style="margin-bottom: 20px;"></div>
                                <table class="table" id="updatePartAttributeTable">
                                    <thead>
                                        <tr>
                                            <th>Product Attribute</th>
                                            <th>Attribute Value</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="updateProductAttributeTable"></tbody>
                                </table>
                                <div class="button-row align-items-start">
                                    <button class="btn btn-primary me-2 ms-2" id="addAttributeToUpdateTable" target-table="updatePartAttributeTable" style="height:30px">Add Row</button>                               
                                </div>
                            </fieldset>
                            <div class="button-row align-items-end justify-content-end mt-5">
                                <button type="submit" class="btn btn-success" id="updatePartBtn">Update</button>
                            </div>
                        </form>
                    </div>                    
                </div>
            </div>            
        </div>
    </div>
    <div id="arrange-part" class="tab-pane fade" role="tabpanel" aria-labelledby="arrange-part">
        <div class="card mt-5">
            <div class="card-header">
                <i class="fa fa-cog fa-spin"></i>&nbsp; Arrange parts
            </div>
            <div class="card-body">
                <form class="row" method="post" asp-page-handler="ArrangePart">
                    <div class="col-md-9">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="row align-items-center">
                                        <label class="control-label">Part</label>
                                        <div class="autocomplete">
                                            <input type="text" class="form-control input-sharp" id="arrangePartList" placeholder="Part number" data-autocomplete-options="arrangePartListData" required="required">
                                            <div id="arrangePartListData" style="display:none;">
                                                @Html.Raw(Json.Serialize(Model.PartNumbers.Select(p => p.Trim())))
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row align-items-center">
                                        <label class="control-label">Section</label>
                                        <select id="sectionSelect" class="form-select form-select-sm" required="required">
                                            <option value="">Select Section</option>
                                            @if (Model.Inventory?.InventorySections is not null)
                                            {
                                                @foreach (var invSection in Model.Inventory?.InventorySections)
                                                {
                                                    <option value="@invSection.Id" data-width="@invSection.Width" data-height="@invSection.Height" data-subspace="@invSection.SubspaceCount">
                                                        @invSection.SectionName
                                                    </option>
                                                }
                                            }
                                        </select>
                                        <label class="control-label">Coordinate (X,Y)</label>
                                    </div>
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <input type="number" name="x-position" class="form-control input-sharp" min="1" value="1"  />
                                        </div>
                                        <div class="col-md-6">
                                            <input type="number" name="y-position" class="form-control input-sharp" min="1" value="1" />
                                        </div>
                                    </div>                                    
                                    <div class="row align-items-center">
                                        <div class="col-md-6 align-items-center">
                                            <label class="control-label">Subspace (Quantity)</label>
                                            <div class="col-md-12">
                                                <div id="subspaceCheckboxes"></div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 align-items-center">
                                            <label class="control-label">Label</label>
                                            <div class="col-md-12">
                                                <input type="text" name="subspaceLabel" id="subspaceLabel" class="form-control input-sharp" placeholder="cabinate label" />
                                            </div>
                                        </div>                                        
                                    </div>
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            @* <input type="checkbox" id="fillAll" />
                                             <label for="fillAll">Fill All</label>
                                            <!-- New input for Fill All quantity -->
                                            <input type="number" id="fillAllQuantity"  class="form-control input-sharp" value="0" min="0" disabled />*@
                                        </div>
                                    </div>

                                    <label class="control-label">Group</label>
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <input type="text" id="partGroup" class="form-control input-sharp autocomplete" placeholder="e.g., USB" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="button-row btn btn-primary" id="arrangePartBtn" style="margin-top: 20px;">Submit</button>
                                    </div>
                                </div>
                            </div>                            

                        </div>
                    </div>
                </form>
                <form class="well form-horizontal" style="margin-top: 20px;">
                    <legend><h2>List</h2></legend>
                    <hr />
                    <fieldset>
                        <div style="margin-bottom: 20px;"></div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            <!-- Add scrollable container -->
                            <table class="table" id="searchedProductSpecTable">
                                <thead>
                                    <tr>
                                        <th>Part number</th>
                                        <th>Section</th>
                                        <th>Coordinate (X)</th>
                                        <th>Coordinate (Y)</th>
                                        <th>Subspace(Qnt.)</th>
                                        <th>Label</th>
                                        <th>Group</th>
                                        <th>Action</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="partBinAssignmentTableBody"></tbody>
                            </table>
                        </div>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
    <div id="usage-part" class="tab-pane fade" role="tabpanel" aria-labelledby="usage-part">
        <div class="card mt-5">
            <div class="card-header">
                <i class="fa fa-ravelry" aria-hidden="true"></i>&nbsp; Part usage
            </div>
            <div class="card-body">
                <form class="row" method="post" asp-page-handler="UsePart">
                    <div class="col-md-9">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="control-label">Part</label>
                                    <div class="autocomplete">
                                        <input type="text" class="form-control input-sharp" id="usepartNumber" placeholder="Part number" data-autocomplete-options="partNumbersData">
                                        <div id="partNumbersData" style="display:none;">
                                            @Html.Raw(Json.Serialize(Model.PartNumbers.Select(p => p.Trim())))
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="button-row btn btn-primary" id="usePartBtn">Search</button>
                            </div>
                        </div>
                    </div>
                </form>
                <hr />
                <form class="well form-horizontal" style="margin-top: 20px;">
                    <legend><h2>Location</h2></legend>
                    <hr />
                    <fieldset>
                        <div style="margin-bottom: 20px;"></div>
                        <table class="table" id="usePartTable">
                            <thead>
                                <tr>
                                    <th>Part</th>
                                    <th>Section</th>
                                    <th>Coordinate X</th>
                                    <th>Coordinate Y</th>
                                    <th>Subspace</th>
                                    <th>Label</th>
                                    <th>Quantity</th>
                                    <th>Use</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="~/lib/jquery-validation/dist/jquery.validate.js"></script>

<script type="text/template" id="tr_template">
    <td class="dtable-col1"></td>
    <td class="dtable-col2"></td>
    <td><a data-mode='edit' class="action" href="javascript:void(0)">edit</a></td>
    <td><a class="delete" href="javascript:void(0)">delete</a></td>
</script> 


<script type="module">
    import Autocomplete from "https://cdn.jsdelivr.net/gh/lekoala/bootstrap5-autocomplete@master/autocomplete.js";
    const opts = {
        onSelectItem: console.log,
    };    
    var packageList = [];
    var groupList = [];

    @for (int i = 0; i < @Model.Packages.Count; i++)
    {
        @if (Model.Packages[i] != null)
        {
            @:packageList.push({
            @:title: "@Model.Packages[i].Name?.Trim()",  
            @:id: "@(Model.Packages[i].Id)",
            @:data: {
            @:key: @i,
            @:    }
            @:});
        }
    }
    @for (int i = 0; i < @Model.Group.Count; i++)
    {
        @if (Model.Group[i] != null)
        {
            @:groupList.push({
            @:title: "@Model.Group[i].Name?.Trim()",
            @:id: "@(Model.Group[i].Id)",
            @:data: {
            @:key: @i,
            @:    }
            @:});
        }
    }

    Autocomplete.init("#packageInput", {
            items: packageList,
            valueField: "id",
            labelField: "title",
            highlightTyped: true,
            onSelectItem: console.log,
        });   
    Autocomplete.init("#groupInput", {
        items: groupList,
        valueField: "id",
        labelField: "title",
        highlightTyped: true,
        onSelectItem: console.log,
    });

</script>

<script type="text/javascript">
    
    function isValidUrl(string) {
        try {
            new URL(string);
            return true;
        } catch (_) {
            return false;
        }
    }

    $(document).ready(function () {

        let selectedCategoryForCreatePart = null;
        let selectedCategoryForUpdatePart = null;

        var data = @Html.Raw(JsonSerializer.Serialize(Model.Categories, new JsonSerializerOptions
              {
                  PropertyNamingPolicy = JsonNamingPolicy.CamelCase,
                  DefaultIgnoreCondition = System.Text.Json.Serialization.JsonIgnoreCondition.WhenWritingDefault
              }));

        const creatPartTree = new DinampTreeEditor('.create-part-category-treeview')
                                  .setData(data)
                                  .set({
                                        radios: true,
                                        editable: false,
                                        checkboxes: false,
                                        oncheck: function (state, text, path) {
                                        selectedCategoryForCreatePart = path;
                }
            });

        const updatePartTree = new DinampTreeEditor('#update-part-category-treeview')
                                   .setData(data)
                                   .set({
                                            radios: true,
                                            editable: false,
                                            checkboxes: false,
                                            oncheck: function (state, text, path) {
                                            selectedCategoryForUpdatePart = path;
                                            }});

        $('#addAttributeToUpdateTable').prop('disabled', true);
        $('#updateAttribute').prop('disabled', true);

        $('#templateList').on('change', function (event) {
            //var selectedId = document.getElementById("templateList").value;
            var selectedId = $(this).val();
            var selectedText = $(this).find('option:selected').text();
            $('#attributeName').val(selectedText.trim());
            var targetTableId = $(this).attr('target-table'); // Get the ID from the target-table attribute
            var table = $('#' + targetTableId); // Select the table using the ID
            table.find('tbody').empty();
            $.ajax({
                type: 'POST',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                url: '/dashboard/template?handler=LoadTemplatesDefaultAttributes&templateGuid=' + selectedId,
                contentType: 'application/json',
                success: function (response) {
                    console.log('Data saved successfully:', response);
                    if (table.length) { // Check if the table exists
                        $.each(response, function (index, item) {
                            appendRowToTable(table, item.name, item.value, item.guidId);
                        });                       
                    } else {
                        console.error('Table with ID "' + targetTableId + '" not found.');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error saving data:', status, error);
                    alert('Failed to save data.');
                }
            });

        });        
        $('#addSupplier').on('click', function (event) {
            event.preventDefault();
            var targetTableId = $(this).attr('target-table'); // Get the ID from the target-table attribute
            var table = $('#' + targetTableId); // Select the table using the ID
            if (table.length) { // Check if the table exists
                appendRowToTable(table); // Call the function with the table jQuery object
            } else {
                console.error('Table with ID "' + targetTableId + '" not found.');
            }
        });
        $('.search-dropdown').each(function () {
            var $dropdown = $(this);
            var $input = $dropdown.find('.search-input');
            var $menu = $dropdown.find('.dropdown-menu');

            $input.on('input', function () {
                var inputValue = $input.val();
                var dataAttribute = $input.attr('data-source');
                var results = JSON.parse(dataAttribute);
                var matchingWords = inputValue ? results.filter(word => word.toLowerCase().includes(inputValue.toLowerCase())) : results;

                $menu.find('li').remove(); // Remove existing list items
                populateList(matchingWords, $menu, $dropdown.find('.dropdown-toggle'));
            });
        });
        $('#fetchDigikey').on('click', function (event) {
            event.preventDefault();
            var targetTableId = $(this).attr('target-table');
            var digiKeyPartNumber = $('#digikeyPartNumber').val();
            var table = $('#' + targetTableId);
            table.find('tbody').empty();
            var url = '@Url.Page("Part", "DigikeyParameters")';
            $.ajax({
                url: url,
                type: 'Get',
                data: {
                    partNumber: digiKeyPartNumber
                },
                success: function (response) {
                    console.log('Data saved successfully:', response);
                    if (table.length) { // Check if the table exists
                        $.each(response, function (index, item) {
                            if (item.category === "Parameter") {
                                appendRowToTable(table, item.name, item.value);

                                if (item.name === "Package / Case") {
                                    $('#packageInput').val(item.value);

                                }
                            }
                            if (item.category === "PhotoUrl" && item.value) {                               
                                if (isValidUrl(item.value)) {
                                    $('#partImage').attr('src', item.value);
                                } else {
                                    console.error('Invalid URL:', item.value);
                                }
                            }
                            if (item.category === "DetailedDescription" && item.value){
                                $('#description').val(item.value);
                                $('#partNumber').val(digiKeyPartNumber);

                            }

                        });
                        $('#supplier').val("DigiKey");
                        // Call the function with the table jQuery object
                    } else {
                        console.error('Table with ID "' + targetTableId + '" not found.');
                    }
                },
                error: function (xhr, status, error) {
                    // Handle any errors here
                    alert('There is an error during the fetch. Please check if the Part number is correct.');
                    console.error(error);
                }
            });
        });
               
        $('#updatePartNumberList').on('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadPartForUpdate(); // Trigger the search on Enter key press
            }
        });
        $('#updatePartNumberList').on('keyup', function () {
            var partNumber = $(this).val();
            if (partNumber.length === 0) {
                $('#addAttributeToUpdateTable').prop('disabled', true);
                $('#updateAttribute').prop('disabled', true);
                var table = $('#searchedProductSpecTable');
                table.find('tbody').empty(); // Clear table if input is empty
            }
        });
        // Disable buttons if the input is cleared
        // Event handler for pressing "Enter" in the input field
        $('#searchPartBtn').on('click', function (event) {
            event.preventDefault();
            loadPartForUpdate(); // Trigger the search
        });
        $('#searchPartNumberForUpdate').on('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                loadPartForUpdate(); // Trigger the search on Enter key press
            }
        });
        // Disable buttons and clear table if input is cleared
        $('#searchPartNumberForUpdate').on('keyup', function () {
            var partNumber = $(this).val().trim();
            if (partNumber.length === 0) {
                $('#addAttributeToUpdateTable').prop('disabled', true);
                $('#updateAttribute').prop('disabled', true);
                var table = $('#searchedProductSpecTable');
                table.find('tbody').empty(); // Clear table if input is empty
            }
        });
        $('#updatePartBtn').on('click', function () {
            event.preventDefault();
            var guidId = $('#searchPartNumberForUpdate').data('guidid');

            var validator = $("#updatePartForm").validate();
            var isValid = validator.form();
            if (!isValid) {
                return;
            }
            var token = $('input[name="__RequestVerificationToken"]').val();

            var groupValue = $('#updatePartGroupInput').val();
            var packageValue = $('#updatePartPackageInput').val();
            var partData = {
                PartNumber: $('#updatePartNumber').val()?.trim(),
                Description: $('#updatePartDescription').val()?.trim(),
                Supplier: $('#updatePartSupplier').val()?.trim(),
                GuidId: guidId,
                Attributes: {},
                PathToCategory: selectedCategoryForUpdatePart
            };
            if (groupValue) {
                partData.Group = groupValue.trim();
            }
            if (packageValue) {
                partData.Package = packageValue.trim();
            }

            var attributesList = [];
            partData.Attributes = attributesList;
            // Iterate over each row in the table to collect attribute details
            $('#updatePartAttributeTable tbody tr').each(function () {
                var row = $(this);
                var guid = row.data('guid'); // Read the data-guid attribute from the row
                var attributeName = row.find('.dtable-col1 input').val()?.trim();
                var attributeValue = row.find('.dtable-col2 input').val()?.trim();

                // Check if both attribute name and value are provided
                if (attributeName) {
                    attributesList.push({
                        guidId: guid || null, // If guid is undefined, set it to null
                        name: attributeName,
                        value: attributeValue || null
                    });
                }
            });
            $.ajax({
                url: '/dashboard/Part?handler=UpdatePart',
                type: 'Post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(partData),
                headers: {
                    'XSRF-TOKEN': token // Include the CSRF token in the request header
                },
                success: function (response) {
                    // Handle successful response
                    console.log(response);
                    event.preventDefault(); // enable validation
                    alert(response.message); // Show success message

                    selectedCategoryForUpdatePart = null;
                    creatPartTree.clear();
                                     
                    if (response.message && response.message.includes("success")) {
                        // Reset the form
                        $('#searchPartForUpdateForm')[0].reset();
                        $('#updatePartForm')[0].reset();
                        selectedCategoryForCreatePart = null;
                        $('#updatePartAttributeTable tbody').empty();
                        $('#updatePartCurrentCategory').empty();
                    }
                    $('#part-details-section').collapse('hide');
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    console.error('Error:', error);
                    // Optionally, you can show an error message
                }
            });
        });
        $('#addAttributeToUpdateTable').on('click', function (event) {
            event.preventDefault(); // Prevent default form submission behavior
            //var targetTableId = $(this).attr('updatePartAttributeTable'); // Get the ID from the target-table attribute
            var table = $('#updatePartAttributeTable'); // Select the table using the ID
            if (table.length) { // Check if the table exists
                appendRowToTable(table); // Call the function with the table jQuery object
            } else {
                console.error('Table with ID updatePartAttributeTable not found.');
            }
        });
        $('#updateAttribute').on('click', function (event) {
            event.preventDefault();
            var partNumber = $('#searchPartNumberForUpdate').val().trim();
            var productAttributes = {};
            $('#productAttributeTable tr').each(function () {
                var row = $(this);
                var attribute = row.find('td').eq(0).find('input').val().trim();
                var value = row.find('td').eq(1).find('input').val().trim();
                productAttributes[attribute] = value;
            });

            $.ajax({
                type: 'POST',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },
                url: '/dashboard/part?handler=UpdatePartAttribute',
                contentType: 'application/json',
                data: JSON.stringify({ attributes: productAttributes, partNumber: partNumber }),
                success: function (response) {
                    console.log('Data saved successfully:', response);
                    alert('Data saved successfully!');
                },
                error: function (xhr, status, error) {
                    console.error('Error saving data:', status, error);
                    alert('Failed to save data.');
                }
            });
           
        });
        $('#createPartBtn').on('click', function (event) { 
         
            event.preventDefault();

            if (selectedCategoryForCreatePart == null) 
            {
                alert("Please select a category");
                return;
            }

            var validator = $("#createPartForm").validate();
            var isValid = validator.form();
            if (!isValid) {
                return;                    
            }
            var token = $('input[name="__RequestVerificationToken"]').val();
            // Gather data from the form fields
            var selectedGuid = $('#templateList').val();
            //var orderDate = $('#orderDate').val();
            var groupValue = $('#groupInput').val();
            var packageValue = $('#packageInput').val();

            var partData = {
                PartNumber: $('#partNumber').val(),
                Description: $('#description').val(),
                Supplier: $('#supplier').val(),                                         
                //OrderNumber: $('#order').val(),
                //OrderQuantity: $('#orderQuantity').val(),
                //CategoryId: $('#categorySelect').val(),
                
                AttributeTemplateGuid: selectedGuid.trim() === '' ? null : selectedGuid,
                Attributes: {},
                PathToCategory: selectedCategoryForCreatePart
            };
            if (groupValue) {
                partData.Group = groupValue;
            }
            // if (orderDate) {
            //     partData.OrderDate = orderDate;
            // }
            if (packageValue) {
                partData.Package = packageValue;
            }

            //Gather attributes from the attribute table
            $('#attributeTable tbody tr').each(function () {
                var attributeName = $(this).find('.dtable-col1 input').val().trim();
                var attributeValue = $(this).find('.dtable-col2 input').val().trim();

                if (attributeName && attributeValue) {
                    partData.Attributes[attributeName] = attributeValue;
                }
            });

            // Send data to the server
            $.ajax({
                url: '/dashboard/Part?handler=CreatePart',
                type: 'Post',
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(partData),
                headers: {
                    'XSRF-TOKEN': token // Include the CSRF token in the request header
                },
                success: function (response) {
                    // Handle successful response
                    console.log(response);
                    event.preventDefault(); // enable validation
                    alert(response.message); // Show success message

                    selectedCategoryForCreatePart = null;
                    creatPartTree.clear();

                    // Optionally, you can redirect or show a success message
                    if (response.message && response.message.includes("success")) 
                    {
                        // Reset the form
                        $('#createPartForm')[0].reset();
                        selectedCategoryForCreatePart = null;
                        $('#attributeTable tbody').empty();
                        $('#templateList').val('');
                    }
                    
                },
                error: function (xhr, status, error) {
                    // Handle error response
                    console.error('Error:', error);
                    // Optionally, you can show an error message
                }
            });
            
        });

        // Listen to the 'input' event on x-position, y-position, and subspace fields
        $('input[name="x-position"], input[name="y-position"], input[name="subspace"]').on('input', function () {
            // Get the current value of the input
            var value = parseInt($(this).val());

            // Get the max value from the respective max attribute
            var maxVal = parseInt($(this).attr('max'));

            // Check if the value exceeds the max, if yes, set it to the max
            if (!isNaN(maxVal) && value > maxVal) {
                $(this).val(maxVal);
            }

            // Prevent negative or zero values
            if (value < 1 || isNaN(value)) {
                $(this).val(1);
            }
        });
        $('#sectionSelect').on('change', function () {
            // Get the selected option
            var selectedOption = $(this).find('option:selected');

            // Get width, height, and subspace from data attributes
            var width = selectedOption.data('width');
            var height = selectedOption.data('height');
            var subspace = selectedOption.data('subspace');

            // Set the maximum values for x and y input fields
            if (width && height) {
                $('input[name="x-position"]').attr('max', width);
                $('input[name="y-position"]').attr('max', height);
            } else {
                // Clear the max values if no valid section is selected
                $('input[name="x-position"]').removeAttr('max').val(1);
                $('input[name="y-position"]').removeAttr('max').val(1);
            }

            // Clear the previous checkboxes
            $('#subspaceCheckboxes').empty();
            $('#fillAll').prop('checked', false); // Uncheck the 'Fill All' checkbox

            // If valid subspace is selected, create checkboxes with numeric inputs
            if (subspace && subspace > 0) {
                for (var i = 1; i <= subspace; i++) {
                    // Create a flex container for each checkbox and numeric input
                    var container = $('<div />', {
                        class: 'subspace-container',
                        style: 'display: flex; align-items: center; margin-bottom: 5px;'
                    });

                    // Create checkbox
                    var checkbox = $('<input />', {
                        type: 'checkbox',
                        class: 'subspace-checkbox',
                        id: 'subspace-' + i,
                        name: 'subspace[' + i + ']',
                        value: i
                    });

                    // Create label
                    var label = $('<label />', {
                        'for': 'subspace-quantity-' + i,
                        text: i,
                        style: 'margin-right: 5px; margin-left: 5px;'
                    });

                    // Create numeric input for the quantity
                    var quantityInput = $('<input />', {
                        type: 'number',
                        class: 'subspace-quantity',
                        id: 'subspace-quantity-' + i,
                        name: 'subspace-quantity[' + i + ']',
                        value: 0,
                        min: 0,
                        style: 'width: 100px; margin-left: 10px;' // Adjust width and margin for alignment
                    });

                    // Append checkbox, label, and quantity input to the container
                    container.append(checkbox).append(label).append(quantityInput);

                    // Append the container to the subspaceCheckboxes div
                    $('#subspaceCheckboxes').append(container);
                }

                // Bind event to individual checkboxes
                $('.subspace-checkbox').on('change', function () {
                    // Check if all checkboxes are selected
                    var allChecked = $('.subspace-checkbox').length === $('.subspace-checkbox:checked').length;
                    $('#fillAll').prop('checked', allChecked); // Check/uncheck "Fill All" based on individual selections

                    // Trigger the same logic as if the 'Fill All' checkbox was clicked
                    if (allChecked) {
                        $('#fillAll').trigger('change'); // Disable individual fields if all checkboxes are checked
                    }
                });

                // Add the "Fill All" checkbox and quantity input at the end
                var fillAllContainer = $('<div />', {
                    id: 'fillAllContainer',
                    style: 'display: flex; align-items: center; margin-bottom: 5px;'
                });

                // Create fill all checkbox
                var fillAllCheckbox = $('<input />', {
                    type: 'checkbox',
                    id: 'fillAll',
                    name: 'fillAll'
                });

                // Create label for fill all checkbox
                var fillAllLabel = $('<label />', {
                    'for': 'fillAll',
                    text: 'Fill All',
                    style: 'margin-right: 5px; margin-left: 5px;'
                });

                // Create numeric input for the "Fill All" option
                var fillAllInput = $('<input />', {
                    type: 'number',
                    class: 'fill-all-quantity',
                    id: 'fillAllQuantity',
                    name: 'fillAllQuantity',
                    value: 0,
                    min: 0,
                    disabled: true,
                    style: 'width: 100px; margin-left: 10px;'
                });

                // Append everything to the fillAllContainer
                fillAllContainer.append(fillAllCheckbox).append(fillAllLabel).append(fillAllInput);

                // Append the container to the UI
                $('#subspaceCheckboxes').append(fillAllContainer);

                // Bind event to 'Fill All' checkbox
                $('#fillAll').on('change', function () {
                    var isChecked = $(this).prop('checked');

                    // Enable/disable 'Fill All' quantity input based on 'Fill All' state
                    $('#fillAllQuantity').prop('disabled', !isChecked);

                    // Check/uncheck all individual subspace checkboxes
                    $('.subspace-checkbox').prop('checked', isChecked);

                    // Disable all individual subspace quantity inputs when 'Fill All' is checked
                    $('.subspace-quantity').prop('disabled', isChecked);

                    if (isChecked) {
                        // Clear the individual subspace quantities
                        $('.subspace-quantity').val('');
                    }
                });
            }
        });

        $('#fillAll').on('change', function () {
            var isChecked = $(this).is(':checked');

            //Enable or disable the Fill All quantity field
            $('#fillAllQuantity').prop('disabled', !isChecked);

            //Disable/enable individual subspace checkboxes and quantities based on 'Fill All' checkbox
            $('.subspace-checkbox').prop('disabled', isChecked);
            $('.subspace-quantity').prop('disabled', isChecked);

            //Clear the values for individual subspace quantities if Fill All is selected
            if (isChecked) {
                $('.subspace-quantity').val('');  //Clear individual subspace quantities when Fill All is selected
            } else {
                //If Fill All is unchecked, you can re-enable and optionally reset the individual subspace quantities as needed
                $('.subspace-quantity').val(0);  //Reset individual subspace quantities
            }
        });
        // Arrange Part Button Click Event
        $('#arrangePartBtn').on('click', function (event) {
            event.preventDefault();

            var partNumber = $('#arrangePartList').val();
            var sectionId = parseInt($('#sectionSelect').val());
            var xPosition = parseInt($('input[name="x-position"]').val());
            var yPosition = parseInt($('input[name="y-position"]').val());

            var subspaceQuantities = {};
            var isFilled = $('#fillAll').prop('checked');
            var fillAllQuantity = isFilled ? parseInt($('#fillAllQuantity').val()) : null;

            if (!isFilled) {
                $('.subspace-checkbox:checked').each(function () {
                    var subspaceId = parseInt($(this).val());
                    var quantity = parseInt($(this).siblings('.subspace-quantity').val());
                    subspaceQuantities[subspaceId] = quantity;
                });
            }

            var data = {
                partNumber: partNumber,
                SectionId: sectionId,
                CoordinateX: xPosition,
                CoordinateY: yPosition,
                SubspaceQuantities: subspaceQuantities,
                Label: $('#subspaceLabel').val(),
                Group: $('#partGroup').val(),
                IsFilled: isFilled,
                FillAllQuantity: fillAllQuantity
            };

            // Validation
            if (!partNumber || !sectionId || !xPosition || !yPosition || (!isFilled && Object.keys(subspaceQuantities).length === 0)) {
                alert("Please fill all the required fields.");
                return;
            }

            // Add a new row to the table
            var newRow = `<tr>
            <td>${$.trim($('#arrangePartList').val())}</td>
            <td>${$.trim($('#sectionSelect option:selected').text())}</td>
            <td>${data.CoordinateX}</td>
            <td>${data.CoordinateY}</td>
            <td>
                ${isFilled
                    ? 'Filled All (' + fillAllQuantity + ')'
                    : Object.keys(subspaceQuantities)
                        .map(k => `(${k}, ${subspaceQuantities[k]})`)
                        .join(', ')}
            </td>

            <td>${data.Label}</td>
            <td>${data.Group}</td>
            <td><button type="button" class="btn btn-danger btn-sm remove-row-btn">Remove</button></td>
        </tr>`;

            $('#partBinAssignmentTableBody').append(newRow);

            // Reset form fields
            resetFormFields();
        });

        // Function to reset form fields
        function resetFormFields() {
            $('#arrangePartList').val('');
            $('#sectionSelect').val('');
            $('input[name="x-position"]').val(1);
            $('input[name="y-position"]').val(1);
            $('#partGroup').val('');
            $('#subspaceLabel').val('');
            $('.subspace-checkbox').prop('checked', false).prop('disabled', false);
            $('.subspace-quantity').val(0).prop('disabled', true);
            $('#fillAll').prop('checked', false);
            $('#fillAllQuantity').val(0).prop('disabled', true);
        }

        // Delete Button Click Event
        $('#partBinAssignmentTableBody').on('click', '.remove-row-btn', function () {
            if (confirm("Are you sure you want to delete this part?")) {
                var $row = $(this).closest('tr'); // Get the row containing the button

                try {
                    // Collect basic data from the row
                    var partData = {
                        partNumber: $row.find('td:eq(0)').text().trim(),
                        sectionName: $row.find('td:eq(1)').text().trim(),
                        coordinateX: parseInt($row.find('td:eq(2)').text().trim()),
                        coordinateY: parseInt($row.find('td:eq(3)').text().trim()),
                        label: $row.find('td:eq(5)').text().trim(),
                        group: $row.find('td:eq(6)').text().trim(),
                        isFilled: false, // Default to false; will update below if needed
                        fillAllQuantity: null,
                        subspaceQuantities: {}
                    };

                    // Extract and parse Subspace or Fill All data from column 4
                    var subspaceText = $row.find('td:eq(4)').text().trim();

                    if (subspaceText.startsWith('Filled All')) {
                        // If "Filled All" is selected
                        partData.isFilled = true;
                        var fillAllMatch = subspaceText.match(/\d+/); // Extract numeric quantity
                        partData.fillAllQuantity = fillAllMatch ? parseInt(fillAllMatch[0]) : null;
                    } else {
                        // Parse SubspaceQuantities (e.g., "(1, 10), (3, 11)")
                        var regex = /\((\d+),\s*(\d+)\)/g; // Matches (key, value) pairs
                        var match;
                        while ((match = regex.exec(subspaceText)) !== null) {
                            partData.subspaceQuantities[parseInt(match[1])] = parseInt(match[2]);
                        }
                    }

                    console.log("Data to send to backend:", partData);

                    // Send an AJAX request to delete the data on the backend
                    $.ajax({
                        url: '/dashboard/Part?handler=DeleteArrangedItem', // Adjust the URL to match your backend endpoint
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(partData),
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader("XSRF-TOKEN",
                                $('input:hidden[name="__RequestVerificationToken"]').val());
                        },
                        success: function (response) {
                            // If successful, remove the row from the table
                            console.log("Delete successful:", response);
                            $row.remove();
                        },
                        error: function (xhr, status, error) {
                            alert('Error: Unable to delete part. Please try again.');
                            console.error("Error Details:", status, error, xhr.responseText);
                        }
                    });
                } catch (error) {
                    alert("An error occurred while processing the delete request.");
                    console.error("Exception Details:", error);
                }
            }
        });

        $('#usePartBtn').on('click', function (event) {
            event.preventDefault();
            var partNumber = $('#usepartNumber').val().trim();
            var token = $('input[name="__RequestVerificationToken"]').val(); // Extract CSRF token
            var table = $('#usePartTable'); // Select the table
            table.find('tbody').empty(); // Clear previous table rows

            if (partNumber.length === 0) {
                alert('Please enter a valid part number.');
                return;
            }

            $.ajax({
                url: '/dashboard/Part?handler=UsePart&partNumber=' + partNumber,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN", token);
                },
                contentType: "application/json; charset=utf-8",
                type: 'POST',
                success: function (response) {
                    if (table.length) { // Check if the table exists
                        if (response.length > 0) {
                            $.each(response, function (index, item) {
                                var newRow = '<tr>' +
                                    '<td>' + item.partNumber + '</td>' +
                                    '<td>' + item.section + '</td>' +
                                    '<td>' + item.coordinateX + '</td>' +
                                    '<td>' + item.coordinateY + '</td>' +
                                    '<td>' + item.subspaceIndices + '</td>' + // Display subspaces as comma-separated indices
                                    '<td>' + item.label + '</td>' +
                                    '<td>' + item.quantity + '</td>' +
                                    // Add the numeric up-down for the Use column
                                    '<td><input type="number" class="use-input" min="0" max="' + item.quantity +
                                    '" data-subspace-indices="' + item.subspaceIndices +
                                    '" data-bin-id="' + item.binId + '" data-part-name="' + item.partNumber + '" data-quantity="' + item.quantity + '"></td>' +

                                    '</tr>';
                                table.find('tbody').append(newRow);
                            });

                            // Enable buttons if data is successfully fetched
                            $('#addAttributeToUpdateTable').prop('disabled', false);
                            $('#updateAttribute').prop('disabled', false);

                            // Add event listener for numeric input
                            $('.use-input').on('keydown', function (e) {
                                if (e.key === "Enter") {
                                    var quantityUsed = parseInt($(this).val(), 10);
                                    var binId = parseInt($(this).data('bin-id'), 10);
                                    var partNumber = $(this).data('part-name');
                                    var quantity = parseInt($(this).data('quantity'), 10);
                                    var subspaceIndices = $(this).data('subspace-indices');

                                    // Perform AJAX request to send the quantity used to the backend
                                    $.ajax({
                                        url: '/dashboard/Part?handler=AdjustQuantity',
                                        type: 'POST',
                                        beforeSend: function (xhr) {
                                            xhr.setRequestHeader("XSRF-TOKEN", token);
                                        },
                                        contentType: 'application/json; charset=utf-8',
                                        data: JSON.stringify({ partNumber: partNumber, binId: binId, quantityUsed: quantityUsed, subspaceIndices: subspaceIndices, quantity: quantity }),
                                        success: function (response) {
                                            alert('Quantity updated successfully');
                                            // Optionally, update the row's quantity in the UI
                                            $(e.target).closest('tr').find('td:nth-child(7)').text(response.newQuantity);
                                        },
                                        error: function (xhr, status, error) {
                                            alert('Failed to update quantity');
                                            console.error('Error:', error);
                                        }
                                    });
                                }
                            });

                        } else {
                            alert('No attributes found for the given part number.');
                        }
                    } else {
                        console.error('Table not found.');
                    }
                },
                error: function (xhr, status, error) {
                    alert('The part number is not valid.');
                    console.error('Error:', error);
                }
            });
        });

        function loadPartForUpdate() {
            var number = $('#searchPartNumberForUpdate').val().trim();
            var token = $('input[name="__RequestVerificationToken"]').val(); // Extract CSRF token
            var table = $('#updatePartAttributeTable'); // Select the table
            table.find('tbody').empty(); // Clear previous table rows

            $('#part-details-section').collapse('hide'); // Initially hide the details section

            if (number.length === 0) {
                alert('Please enter a valid part number.');
                return;
            }

            $.ajax({
                url: '/dashboard/Part?handler=RetrievePart&partNumber=' + number,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN", token);
                },
                contentType: "application/json; charset=utf-8",
                type: 'POST',
                success: function (response) {
                    if (response) {

                        $('#updatePartNumber').val(response.number || '');
                        $('#updatePartDescription').val(response.description || '');
                        $('#updatePartSupplier').val(response.supplier || '');
                        $('#updatePartPackageInput').val(response.package?.name || '');
                        $('#searchPartNumberForUpdate').data('guidid', response.guidId);
                        const flattenedCategory = flattenCategory(response.category);
                        $('#updatePartCurrentCategory').text(flattenedCategory);
                        const groupNames = response.groups && response.groups.length > 0
                            ? response.groups.map(group => group.name).join(', ')
                            : '';
                        $('#updatePartGroupInput').val(groupNames);
                        const table = $('#updatePartAttributeTable');
                        if (response.attributes && response.attributes.length > 0) {
                            $.each(response.attributes, function (index, item) {
                                appendRowToTable(table, item.name, item.value, item.guidId);
                            });
                        }
                        $('#addAttributeToUpdateTable').prop('disabled', false);
                        $('#updateAttribute').prop('disabled', false);
                        $('#part-details-section').collapse('show');
                    } else {
                        alert('No data found for the given part number.');
                    }
                },
                error: function (xhr, status, error) {
                    alert('The part number is not valid.');
                    console.error('Error:', error);
                }
            });
        }

        function flattenCategory(category) {
            let categories = [];
            while (category) {
                categories.push(category.title);
                category = category.children && category.children.length > 0 ? category.children[0] : null;
            }
            return categories.join(' > ');
        }

        function searchPart() {
            var number = $('#searchPartNumberForUpdate').val().trim();
            var token = $('input[name="__RequestVerificationToken"]').val();
            var table = $('#searchedProductSpecTable'); 
            table.find('tbody').empty(); 

            if (number.length === 0) {
                alert('Please enter a valid part number.');
                return;
            }

            $.ajax({
                url: '/dashboard/Part?handler=RetrievePartAttributeDetails&partNumber=' + number,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN", token);
                },
                contentType: "application/json; charset=utf-8",
                type: 'Post',
                success: function (response) {
                    if (table.length) { // Check if the table exists
                        if (response.length > 0) {
                            $.each(response, function (index, item) {
                                appendRowToTable(table, item.name, item.value);
                            });
                            // Enable buttons if data is successfully fetched
                            $('#addAttributeToUpdateTable').prop('disabled', false);
                            $('#updateAttribute').prop('disabled', false);
                        } else {
                            alert('No attributes found for the given part number.');
                        }
                    } else {
                        console.error('Table not found.');
                    }
                },
                error: function (xhr, status, error) {
                    alert('The part number is not valid.');
                    console.error('Error:', error);
                }
            });
        }
    });
</script>

