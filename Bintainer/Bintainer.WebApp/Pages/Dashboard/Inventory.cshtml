@page "/dashboard/inventory"
@using System.Text.Json;
@model InventoryModel
@{
}
@Html.AntiForgeryToken()
<link rel="stylesheet" href="~/css/hierarchy-select.min.css">
<link rel="stylesheet" href="~/css/autocomplete.css">
<style>
    .button-row {
        display: flex;
        align-items: center; /* Vertically center content */
        height: 30px; /* Set height to 30px */
        border-radius: 0; /* Sharp corners for button */
        margin-right: 10px; /* Add margin between button and select */
        font-size: 14px; /* Reduce font size */
    }

    .button-row:active,
    .button-row:focus {
            outline: none; /* Remove outline when button is focused */
    }

</style>
<form id="form1" runat="server">
    <div class="container">
        <h2>Inventory</h2>
        <hr />
        <div class="row align-items-center">
            <div class="col-md-2">
                <div class="row mb-1"><label for="orderNumber" class="form-label">Inventory Name</label></div>
                <div class="row"><label for="orderNumber" class="form-label">Admin</label></div>
            </div>
            <div class="col-md-4">
                <div class="row mb-1"><input type="text" class="form-control input-sharp " id="inventoryName" value="@Model.InventoryName" placeholder="Inventory Name"></div>
                <div class="row"><input type="text" class="form-control input-sharp " value="@User.Identity?.Name" disabled="disabled"></div>

            </div>

        </div>
        <h2>Section List</h2>
        <hr />
        <div class="row">
            <div class="col-9">
                <table class="table" id="sectionlist">
                    <thead>
                        <tr>
                            <th style="width:300px">Section name</th>
                            <th style="width:150px;">Width</th>
                            <th style="width:150px;">Hight</th>
                            <th style="width:150px;">Sub-sections</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Sections.Count; i++)
                        {
                            <tr id="@Model.Sections[i].Id">
                                <td>
                                    <input type="text" name="section-name" class="form-control input-sharp" value="@Model.Sections[i].SectionName" />
                                </td>
                                <td>
                                    <input type="number" name="section-width" class="form-control input-sharp" min="1" value="@Model.Sections[i].Width" />
                                </td>
                                <td>
                                    <input type="number" name="section-height" class="form-control input-sharp" min="1" value="@Model.Sections[i].Height" />
                                </td>
                                <td>
                                    <input type="number" name="bin-section" class="form-control input-sharp" min="1" value="@((Model.Sections[i].SubspaceCount == null) ? 1 : Model.Sections[i].SubspaceCount)" />
                                </td>
                                <td>
                                    @if (i == 0)
                                    {
                                        <button type="button" class="btn button-row btn-primary btn-xs classAdd">Add</button>
                                    }
                                    else
                                    {
                                        <div class="button-row">
                                            <button type="button" class="btn button-row btn-primary btn-xs classAdd">Add</button>
                                            <button type="button" class="btn button-row btn-danger btn-xs btnDelete">Remove</button>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <div class="button-row align-items-end justify-content-end mt-5">
                    <button type="button" id="submitBtn" class="button-row btn btn-primary btn-md pull-right btn-sm">Submit</button>
                </div>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript">
    $(document).ready(function () {
        $(document).on("click", ".classAdd", function () { 
            var rowCount = $('.inventory-subsection-list').length + 1;
            var contactdiv = '<tr id="0" class="inventory-subsection-list">' +
                '<td><input type="text" name="section-name' + rowCount + '" class="form-control input-sharp" /></td>' +
                '<td><input type="number" name="section-width' + rowCount + '" class="form-control input-sharp" min="0"/></td>' +
                '<td><input type="number" name="section-height' + rowCount + '" class="form-control input-sharp" min="0"/></td>' +
                '<td><input type="number" name="bin-section' + rowCount + '" class="form-control input-sharp" min="0"/></td>' +
                '<td><div class ="button-row"><button type="button" id="btnAdd" class="button-row btn btn-xs btn-primary classAdd">Add</button>' +
                '<button type="button" id="btnDelete" class="button-row btn deleteContact btn btn-danger btn-xs btnDelete">Remove</button></div></td>' +
                '</tr>';
            $('#sectionlist').append(contactdiv); // Adding these controls to Main table class
        });
        $(document).on("click", ".btnDelete", function () {
            $(this).closest("tr").remove();
        });
        $(document).on("click", "#submitBtn", function () {
            var sectionList = [];
            $("#sectionlist tbody tr").each(function () {
                var row = $(this);
                var rowData = {
                    Id: row.attr("id"),
                    SectionName: row.find("input[name^='section-name']").val(),
                    Width: parseInt(row.find("input[name^='section-width']").val(), 10),
                    Height: parseInt(row.find("input[name^='section-height']").val(), 10),
                    Subsection: parseInt(row.find("input[name^='bin-section']").val(), 10)
                };
                sectionList.push(rowData);
            });
            var name = $(inventoryName).val();
            $.ajax({
                type: "POST",
                url: '/dashboard/inventory?handler=SubmitForm&inventoryName=' + encodeURIComponent(name),
                contentType: 'application/json',
                data: JSON.stringify(sectionList),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("XSRF-TOKEN",
                        $('input:hidden[name="__RequestVerificationToken"]').val());
                },               
                success: function (response) {
                    console.log('Data saved successfully:', response);
                    alert('Data submitted successfully.');
                },
                error: function (xhr, status, error) {
                    console.error('Error saving data:', status, error);
                    alert('Failed to save data.');
                }
            });
        });


    });
</script>
